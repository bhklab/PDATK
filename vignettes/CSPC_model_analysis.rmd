---
title: "CSPC: Consensus Subtypes in Pancreatic Cancer"
author:
- name: Vandana Sandhu
- name: Heewon Seo
- name: Christopher Eeles
  affiliation:
  - &pm Bioinformatics and Computational Genomics Laboratory, Princess Margaret Cancer Center, University Health Network, Toronto, Ontario, Canada
  email: christopher.eeles@uhnresearch.ca
- name: Benjamin Haibe-Kains
  affiliation:
  - *pm
  - &mbp Department of Medical Biophysics, University of Toronto, Toronto, Canada
  email: benjamin.haibe.kains@utoronto.ca
date: 2021-02-01
output:
    BiocStyle::html_document
vignette: >
    %\VignetteIndexEntry{"CSPC: Consensus Subtypes in Pancreatic Cancer"}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

# COINCIDE

## Preprocess the data

```{r load_data, eval=FALSE}
library(PDATK)
library(S4Vectors)
library(MultiAssayExperiment)
library(qs)

seed <- 1987
reps <- 1000

CSPCmaeRaw <- qread('../data/CSPCmae.qs', nthread=16)

# Subset to only feature shared across all data
CSPCmae <- intersectRows(CSPCmaeRaw)
```

```{r feature_ranking, eval=FALSE}
experiments(CSPCmae) <- endoapply(experiments(CSPCmae), rankFeatures)

top20FeaturesPerCohort <- lapply(experiments(CSPCmae), getTopFeatures, numFeats=20)
top20PctFeaturesOverall <- getTopFeatures(CSPCmae, 
    numFeats=floor(0.2*length(rownames(CSPCmae)[[1]])), na.rm=TRUE)
topFeatures <- unique(c(top20PctFeaturesOverall, unlist(top20FeaturesPerCohort)))
```

```{r normalize_MAE, eval=FALSE}
topFeaturesMAE <- CSPCmae[topFeatures, , ]
normMAE <- normalize(topFeaturesMAE, MARGIN=1, 
    method=c('medianImpute', 'scale', 'center'))
```

## Create and Train a ConsensusClusterModel

```{r, eval=FALSE}
set.seed(seed)
conClustModel <- ConsensusMetaclusteringModel(normMAE, randomSeed=seed)
trainedConClustModel <- trainModel(conClustModel, reps=reps)
classifiedConClustModel <- predictClasses(trainedConClustModel)
```

```{r, eval=FALSE}
normalsMAE <- qread('../data/normalsMAE.qs')
topFeatsNormalMAE <- normalsMAE[topFeatures, ]
preprocNormMAE <- normalize(topFeatsNormalMAE, MARGIN=1, 
  method=c('medianImpute', 'scale', 'center'))
```

```{r, eval=FALSE}
normalsConClustModel <- ConsensusMetaclusteringModel(preprocNormMAE, 
  randomSeed=seed)
trainedNormalsConClustModel <- trainModel(normalsConClustModel, reps=reps)
classifiedNormConClustModel <- predictClasses(trainedNormalsConClustModel)
```

```{r}
validatedConClustModel <- validateModel(model=classifiedConClustModel, 
    valData=classifiedNormConClustModel)
qsave(validatedConClustModel, file='valConClustModel_1000r.qs')
```

# Network Community Search

```{r }
validatedConClustModel <- qread('vignettes/valConClustModel_1000r.qs')
NCSmodel <- NetworkCommunitySearchModel(model=validatedConClustModel)
trainedNCSmodel <- trainModel(NCSmodel)
classifiedNCSmodel <- predictClasses(trainedNCSmodel)
```

```{r }
clusterNetworkGraph <- plotNetworkGraph(classifiedNCSmodel)
pdf('metacluster_network_graph.pdf')
clusterNetworkGraph
dev.off()
```

# Metacluster Survival Analysis

```{r }
metaclusteredMAE <- trainData(classifiedNCSmodel)
SEhasSurvivalColumns <- lapply(experiments(metaclusteredMAE), hasColDataColumns, 
    values=c('vital_status', 'days_to_death'))
mclustSurvMAE <- metaclusteredMAE[,, unlist(SEhasSurvivalColumns)]
experiments(mclustSurvMAE) <- endoapply(experiments(mclustSurvMAE), 
    FUN=SurvivalExperiment, survival_time='days_to_death', 
    event_occurred='vital_status')
experiments(mclustSurvMAE) <- endoapply(experiments(mclustSurvMAE), 
    dropNotCensored)
```

```{r}
coxModel <- CoxModel(mclustSurvMAE, survivalPredictor='metacluster_label')
fitCoxModel <- trainModel(coxModel)
```

```{r }
survPlotL <- ggsurvplot_list(models(fitCoxModel)$survivalCurves), models(fitCoxModel)$modelData)
```

# Gene Signature Comparison




# Biomarker Comparison




# Single Sample Classifier




# COMPASS Subtyping Waterfall



# PharmacoGx Cell-line Subtyping




# PharmacoGx Cell-line Drug Sensitivity




# PDXE Drug Subtyping



# Cellularity Comparison




# Copy Number Abberation




# Cluster Meta-effect Size




# Pathway Analysis




# Published Classifier Subtyping



# References


