---
title: "Run CSPSC"
author: "Christopher Eeles"
date: "11/05/2020"
output: html_document
---

```{r message=FALSE}
#library(PanCuRx)
require(IDPmisc)
library(dplyr)
library(matrixStats)
library(factoextra)
library(NbClust)
library(cluster)
library(ConsensusClusterPlus)
library(clusterRepro)
library(igraph)
library(gtools)
library(plyr)
library(survival)
library(randomForest)
library(switchBox)
library(impute)
library(KMsurv)
library(scales)
library(switchBox)
library(survminer)
library(limma)
library(piano)
require(ggplot2)
library(ggpubr)
library(BiocParallel)
library(qs)
library(data.table)
library(effsize)
library(vcdExtra)
library(survcomp)
library(RColorBrewer)
library(lattice)
library(ggplotify)
library(BBmisc)
library(gridExtra)
library(ggsci)
library(cowplot)
```

## 1. COINCIDE Implementation

```{r load_data}
cohortsDataL <- readRDS('../data/cohortsCommonGenes.rds')       
normalGTEx <- readRDS('../data/normalGTEx.rds')
adjNormal <- readRDS('../data/adjacentNormal.rds')
```


```{r source_function}
source('../R/utilities.R')
source('../R/COINCIDE.R')
source('../R/networkCommunitySearch.R')
source('../R/geneSignatureComparison.R')
source('../R/biomarkerComparison.R')
source('../R/singleSampleClassifier.R')
source('../R/compassSubtypeWaterfall.R')
source('../R/PDXdrugSubtyping.R')
source('../R/cancerCellineDrugSensitivities.R')
source('../R/cellularityComparison.R')
source('../R/copyNumAberration.R')
source('../R/clusterMetaEffectSizeCalculation.R')
source('../R/pathwayAnalysis.R')
```


```{r rorder_cohorts_to_match}
cohortOrder <-c("pcsi", "tcga", 
                "kirby", "icgc_seq", 
                "ouh", "winter", 
                "collisson", "zhang", 
                "grutzmann", "chen", 
                "unc", "icgc_arr", 
                "balagurunathan", "badea", 
                "pei", "haider", 
                "lunardi", "yang", 
                "hamidi", "janky", "bauer")
cohortsDataL <- cohortsDataL[cohortOrder]
```

```{r ranking_genes_based_on_mad}
cohortMADrankings <- bplapply(cohortsDataL, function(cohort) calcRowMADdf(cohort))
```

```{r rank_cohort_genes_by_MAD}
geneWiseWeightedMADdf <- calcGeneWiseWeightedMADdf(cohortMADrankings)
```


```{r get_top_ranked_genes}
top20genesPerCohort <- getTopGenes(cohortMADrankings, n=20)
```


```{r get_top_genes_and_meta_genes}
metaGenes <- getMetaGenes(cohortMADrankings, geneWiseWeightedMADdf, n=20, m=2066)

resultsDir <- file.path("..", "results")
saveRDS(metaGenes, file.path(resultsDir, "metaGenes.rds"))
```



```{r preprocess_cohort_expression_matrixes}
preprocCohorts <- preprocessCohorts(cohortsDataL, metaGenes)
```



```{r compute_consensus_cluster}
consensusClusters <- bplapply(preprocCohorts,
                              consensusClusterCohort,
                              maxK=5, distance="pearson", 
                              method="hc", seed=1987)
```

```{r consensus_cluster_normals_and_GTEx_normals}
normalCohorts <- list("normals"=adjNormal, 
                      "normalsGTEx"=normalGTEx)

preprocNormals <- preprocessCohorts(normalCohorts, metaGenes)
conClustNormals <- bplapply(preprocNormals,
                            consensusClusterCohort,
                            maxK=5, distance="pearson", 
                            method="hc", seed=1987)
```

```{r append_normals_to_cohorts}
allConClusters <- c(consensusClusters, conClustNormals)
allProcCohorts <- c(preprocCohorts, preprocNormals)
```


```{r get_all_pairs}
cohortPairs <- findAllCohortPairs(names(allConClusters))
```


```{r calculate_thresholds}
# 
MSMthresholds <- calcAllMSMthresholds(cohortPairs, allConClusters, allProcCohorts, nthread=16)
```


```{r compare_all_clusters}
a <- Sys.time()
allClusterRepro <- calcAllClusterRepro(MSMthresholds, allConClusters, 
                                       allProcCohorts, nthread=16, numReps=500,
                                       seed=1987)
b <- Sys.time()
b - a
```


```{r }
qsave(allClusterRepro, file.path('..', 'data', 'allClusterRepro.qs'), nthread=16)
```

```{r }
clusterEdges <- compareClusters(MSMthresholds, allClusterRepro, pValue=0.05, actualIGP=0.5, minThresh=0)
qsave(clusterEdges, file.path('..', 'data', 'clusterEdges.qs'), nthread=15)
```

```{r }
graphData <- getClusterNetworkData(clusterEdges, seed=1987)
graphData$metaClusters
```

```{r }
possibleClusters <- findAllPossibleClusters(allConClusters)
notClustered <- findCohortsNotClustered(possibleClusters, graphData$metaClusters)
notClustered
```

```{r cohortwise_classes}
cohortwiseClasses <- getCohortwiseClasses(graphData$metaClusters, notClustered)
cohortwiseClasses
```

```{r cohortCluster_samples}
clusterwiseSamples <- getClusterwiseSamples(cohortwiseClasses, allConClusters)
```

```{r }
annotatedClusters <- annotateSampleMetaClasses(allConClusters, clusterwiseSamples)
saveRDS(annotatedClusters, file.path("..", "results", "annotatedClusters.rds"))
```

## 2. Network Community Search

```{r cluster_network, fig.height=10, fig.width=10}
plotClusterNetwork(clusterEdges, seed=1987, 
                   savePath=file.path('..', 'results'),
                   fileName='clusterNetworkGraph.pdf')
```

```{r load_expression_data}
load(file=file.path('..', 'data', 'PDACexpressionData.rda'))
load(file=file.path('..', 'data', 'yangSurvival.rda'))
```

```{r extract_survival_data}
# Drop old PCSI
PDACexpressionData <- PDACexpressionData[which(names(PDACexpressionData) != "pcsi")]
survivalData <- extractSurvivalData(PDACexpressionData, yangSurvival)
head(survivalData)
```


```{r extract_meta_clusters}
metaClusters <- extractMetaClusters(annotatedClusters, survivalData)
head(metaClusters)
```


```{r merge_to_samples_with_survival_data}
metaClusterSurvival <- mergeOn(survivalData, metaClusters, "sampleNames")
head(metaClusterSurvival)
```


```{r annotate_metaClusters}
metaClusterSurvAnnot <- annotateMetaClusters(metaClusterSurvival, c("Basal", "Exocrine", "Classical"))
head(metaClusterSurvAnnot)
```


```{r fit_cox_model}
proportionalHarzardsModel <- fitProportionalHazardsModel(metaClusterSurvAnnot)
summary(proportionalHarzardsModel)
```

```{r }
survivalCurves <- fitSurvivalCurves(metaClusterSurvAnnot)
```

```{r }
plotSurvivalCurves(survivalCurves)
```

```{r, fig.height=12, fig.width=12}
plotCohortwiseSurvivalCurves(metaClusterSurvAnnot)
```

## 3. Gene Signature Comparison

```{r }
sampleMetaClassDT <- extractSampleMetaClasses(annotatedClusters)
head(sampleMetaClassDT)
```

```{r }
geneSigL <- readRDS(file=file.path("..", "data", "geneSigList.rds"))
sigScoreL <- mapply(computeSignatureScoreDT, geneSigL, 
                    MoreArgs=list(cohortsDataL=cohortsDataL, 
                                  sampleMetaClassDT=sampleMetaClassDT),
                    SIMPLIFY=FALSE)
```

```{r fig.height=10, fig.width=12}
comparisons <- list(c("Basal", "Classical"), 
                    c("Classical", "Exocrine"),
                    c("Exocrine", "Basal"))
sigScorePlotL <- mapply(plotSigScores, 
                        cohortSignatureScoreDT=sigScoreL,
                        signatureScoreName=names(sigScoreL),
                        MoreArgs=list(comparisons=comparisons),
                        SIMPLIFY=FALSE)
sigScorePlots <- grid.arrange(grobs=sigScorePlotL)
ggsave(file=file.path("..", "data", "sigScorePlots.pdf"), sigScorePlots)
```

## 4. Biomarker Comparison

```{r }
biomarkers <- c("EGFR", "SNAI2", "KRT81", "GATA6", "CYP3A5", "HNF1A",
                         "REG1A", "REG1B", "REG3A", "CEL")
names(biomarkers) <- c(rep("Basal", 3), rep("Classical", 3), rep("Exocrine", 4))
geneBiomarkerScoreL <- lapply(biomarkers, computeGeneBiomarkerScores, 
                              cohortsDataL=cohortsDataL,
                              sampleMetaClassDT=sampleMetaClassDT)
names(geneBiomarkerScoreL) <- biomarkers
```

```{r }
biomarkerScoreBoxplotL <- boxplotBiomarkerScoresList(geneBiomarkerScoreL, 
                                                     biomarkers,
                                                     comparisons)
```

```{r basal_class_boxplots, fig.height=10, fig.width=10}
scoreClasses <- names(biomarkerScoreBoxplotL)
scoreIdxs <- which(scoreClasses %in% "Basal")
basalPlots <- grid.arrange(grobs=biomarkerScoreBoxplotL[scoreIdxs], ncol=2)
ggsave(file.path("..", "results", "basalBiomarkerBoxPlots.pdf"))
basalPlots
```

```{r classical_class_boxplots, fig.height=10, fig.width=10}
scoreIdxs1 <- which(scoreClasses %in% "Classical")
classicalPlots <- grid.arrange(grobs=biomarkerScoreBoxplotL[scoreIdxs], ncol=2)
ggsave(file.path("..", "results", "classicalBiomarkerBoxPlots.pdf"))
classicalPlots
```

```{r exocrine_class_boxplots, fig.height=10, fig.width=10}
scoreIdxs <- which(scoreClasses %in% "Exocrine")
exocrinePlots <- grid.arrange(grobs=biomarkerScoreBoxplotL[scoreIdxs], ncol=2)
ggsave(file.path("..", "results", "exocrineBiomarkerBoxPlots.pdf"))
exocrinePlots
```


## 5. Single Sample Classifier

```{r }
cohortCommMat <- computeCohortCommunityMatrix(cohortsDataL, metaGenes)
```

```{r train_single_sample_classifiers}
uniqueMetaClasses <- na.omit(unique(sampleMetaClassDT$metaClasses))
singleSampleClassifiers <- lapply(uniqueMetaClasses,
                                  trainSingleSampleClassifer,
                                  cohortComMat=cohortCommMat,
                                  sampleMetaClassDT=sampleMetaClassDT,
                                  maxK=20)
names(singleSampleClassifiers) <- uniqueMetaClasses
```

```{r get_predicted_genes}
classTSPs <- lapply(singleSampleClassifiers, `[[`, "TSPs")
topGenes1 <- lapply(classTSPs, `[`, i=TRUE, j=1)
topGenes2 <- lapply(classTSPs, `[`, i=TRUE, j=2)
```

```{r get_top_features}
lengthTopGenes <- lapply(topGenes1, length)
topGenesClasses <- mapply(rep, names(topGenes1), times=lengthTopGenes, SIMPLIFY=FALSE)
featuresDT <- data.table("class"=unlist(topGenesClasses),
                         "genes"=unlist(lapply(c(topGenes1, topGenes2), unlist)))
genePairs <- paste(unlist(topGenes1), unlist(topGenes2), sep=">")
```

```{r subset_matrix_to_top_genes}
keepSamples <- intersect(colnames(cohortCommMat), unique(sampleMetaClassDT$samples))
cohortTopGenesMat <- cohortCommMat[featuresDT$genes, keepSamples]
sampleMetaClassDT <- sampleMetaClassDT[!duplicated(samples) & samples %in% keepSamples, ]
metaClassesFactor <- as.factor(sampleMetaClassDT$metaClasses)
```

```{r compare_top_genes}
g1Gt2Matrix <- calcTopGenes1Gt2Matrix(cohortTopGenesMat, topGenes1, topGenes2, genePairs)
g1Gt2Matrix[1:5, 1:5]
```

```{r make_model_predictions}
################## DONT CLICK ME ############################
sampleClassPreds <- predictSingleSampleClasses(g1Gt2Matrix, metaClassesFactor, nthread=14)
qsave(sampleClassPreds, file.path('..', 'results', 'sampleClassPreds.qs'))
```

```{r predict_binary_rf_model}
binaryRFmodel <- randomForest(t(g1Gt2Matrix), metaClassesFactor)
```

```{r }
topGenesDT <- data.table("topGenes1"=unlist(topGenes1), "topGenes2"=unlist(topGenes2), "genePairs"=genePairs, "classes"=unlist(topGenesClasses))
```

```{r }
classPredDT <- data.table(sampleClassPreds)
classPredDT$samples <- names(sampleClassPreds)
singleSampClassifDT <- merge(classPredDT, sampleMetaClassDT, on=samples, sort=FALSE)
```

## 6. Compass Subtyping Waterfall

```{r load_data}
compassSurvDT <- fread(file.path("..", "data", "compassSurvDT.csv"))
compassLogExprMat <- read.csv(file.path("..", "data", "compassLogExprMat.csv"),
                              row.names="X")
```

```{r }
sampleMetaClassPredDT <- predictSampleMetaClass(compassLogExprMat, binaryRFmodel, 
                                                topGenesDT, g1Gt2Matrix, 
                                                metaClassesFactor)
table(sampleMetaClassPredDT$predClass)
```

```{r }
sampClassPredwSurvivalDT <- merge(sampleMetaClassPredDT, compassSurvDT, by="sample")
setorderv(sampClassPredwSurvivalDT, cols="tumorResponse", order=-1)
head(sampClassPredwSurvivalDT)
```

```{r tumor_response_all_drug_all_classes, fig.height=8, fig.width=12}
waterfallPlotTumorResponse(sampClassPredwSurvivalDT)
```

```{r tumor_response_basalvclassical_ffx, fig.height=8, fig.width=12}
survBasalvClassicalDT <- 
  sampClassPredwSurvivalDT[predClass %in% c("Basal", "Classical") & 
                             drug %in% c("FFx", "FFx x 1")]

classSurvComparison <- survfit(Surv(OS, OSstatus) ~ predClass, 
                               data=survBasalvClassicalDT)

pValue <- surv_pvalue(classSurvComparison)$pval.txt

waterfallPlotTumorResponse(survBasalvClassicalDT, noXaxis=TRUE, pVal=pValue)
```

```{r prop_hazards_model}
classSurvProHarzardsModel <- coxph(Surv(OS, OSstatus) ~ predClass, 
                                  data=survBasalvClassicalDT)
summary(classSurvProHarzardsModel)
```

```{r compass_NLR}
classNLRcompDT <- sampClassPredwSurvivalDT[order(NLR, decreasing=TRUE), ]
classNLRcompDT <-classNLRcompDT[!is.na(NLR), ]
boxplotClassNLR(classNLRcompDT)
```

```{r fig.height=8, fig.width=12}
compassPlotBiomarkers(compassLogExprMat, sampClassPredwSurvivalDT, 
                      biomarkers=biomarkers[names(biomarkers) %in% c("Basal", "Classical")])
```

## 7. PharmacoGx Cellline Subtyping

```{r load_and_format_data}
PGxCelllinesL <- readRDS(file.path('..', 'data', "PharmacoGxCelllines.rds"))
PGxCLLAvgRepsL <- lapply(PGxCelllinesL, limma::avereps)
```

```{r }
PGxCCLpreds <- lapply(PGxCLLAvgRepsL, predictSampleMetaClass, 
                      classifModel=binaryRFmodel, topGenesDT=topGenesDT, 
                      trainData=g1Gt2Matrix, trainLabels=metaClassesFactor)
```

```{r }
saveRDS(PGxCCLpreds, file.path("..", "results", "PGxSubtypePredictions"))
```

## 8. PharmacoGx Cellline Drug Sensitivity 

```{r load_data_and_process}
CCLsensitivityL <- readRDS(file.path("..", "data", "CCLdrugSensitivityAUCs.rds"))
```

```{r format_data}
CCLsensitivityDtL <- formatCCLsensitivityLtoDT(CCLsensitivityDtL)
```

```{r merge_drugs_and_classes}
mergedCelllineDT <- mergeClassAndDrugs(PGxCCLpreds, CCLsensitivityDtL)
```

```{r get_wilcox_test_pvals}
# Remove GDSC as non-NA AUCs are only in one class
wilcoxPvals <- computeWilcoxOnSharedDrugs(mergedCelllineDT[dataset != "GDSC"], 
                                          class1="Basal", class0="Classical")
wilcoxPvals$CCLE
```

```{r }
concordanceInds <- computeConcIndOnSharedDrugs(mergedCelllineDT, class="Basal")
concordanceInds
```

```{r meta_stats}
metaStatsDT <- calculateMetaStats(concordanceInds)
```

```{r AUC_boxplots}
# Exclude GDSC due to NA stats
plot <- boxplotAUCperSubtypePerDataset(mergedCelllineDT[dataset != "GDSC"],
                                       concordanceInds[names(concordanceInds) != "GDSC"])

```

```{r fig.height=12, fig.width=12}
ggarrange(plotlist=plot, ncol=.ceilSqrt(plot), nrow=.ceilSqrt(plot))
```

## 9. PDXE Drug Subtyping

```{r load_data}
# Why is first dataset here? Nothing is done with it?
PDXgeneExpr <- fread(file.path("..", "data", "PDXgeneExpr.csv"))
PDXgeneExprSet <- readRDS(file.path("..", "data", 'PDXexprSet.rds'))
PDXdrugResponse <- fread(file.path('..', 'data', 'PDXdrugResponse.csv'))
```

```{r }
PDXgeneExprClassDT1 <- preprocPDXdata(PDXgeneExprDT, binaryRFmodel, topGenesDT,
                                      g1Gt2Matrix, metaClassesFactor)
```

```{r}
PDXgeneExprClassDT2 <- preprocPDXdata(exprs(PDXgeneExprSet), binaryRFmodel, 
                                      topGenesDT, g1Gt2Matrix, 
                                      metaClassesFactor)
table(PDXgeneExprClassDT2$predClass)
```

```{r format_drug_response}
PDXdrugResp <- PDXdrugResponse[, .(patient.id, drug, AAC)]
colnames(PDXdrugResp) <- c('sample', 'drug', 'AAC')
```

```{r }
PDXmergedDT <- merge(PDXgeneExprClassDT2, PDXdrugResp, by="sample")
```

```{r }
plots <- boxplotPDXsubtypePerDrug(PDXmergedDT)
```

```{r }
plotGrids <- ggarrangePlotL(plots, 6)
```

```{r fig.height=12, fig.width=8}
for (pGrid in plotGrids) {
  grid.draw(pGrid)
}
```

## 10. Cellarity Comparison

```{r load_data}
cellularityFileL <- list.files(file.path("..", "data"), 
                               pattern="cellularity.*tsv", 
                               full.names=TRUE)
cohortCellularity <- lapply(cellularityFileL, fread, sep="\t")
names(cohortCellularity) <- gsub('^.*/|_.*$', '', cellularityFileL)
cohortCellularityDT <- rbindlist(cohortCellularity)
```

```{r }
annotSampMetaClassDT <- annotateSampleMetaClassDT(sampleMetaClassDT)
mergedCohortCellDT <- merge(cohortCellularityDT, annotSampMetaClassDT, by.x="sample", by.y="samples")
```

```{r }
boxplotCellarityByCohort(mergedCohortCellDT, 
                         saveDir=file.path("..", "results"),
                         fileName="cohortCellularityBoxplot.pdf")
```

## 11. Copy Number Abberation

```{r load_data}
copyNumSNPposDT <- fread(file.path("..", "data", "copyNumSNPpos.csv"))
osloTCGAcnScores <- fread(file.path('..', 'data', 'osloTCGAcnScores.csv'))
```

```{r }
setDTthreads(14)
CNAscoreByProbeDT <- countCNAscoresByProbe(osloTCGAcnScores, copyNumSNPposDT, annotSampMetaClassDT)
```

```{r }
chrScorePlots <- plotPerChromosomeCNAscores(CNAscoreByProbeDT)
```
```{r fig.height=14, fig.width=14}
ggarrangePlotL(chrScorePlots, 9)
```

## 12. Calculate Cluster Meta-Effect Size

```{r }
genewiseCohortsDT <- makeGenewiseCohortsDT(preprocCohortDataL, annotSampMetaClassDT)
```

```{r }
# TODO:: Rewrite this with group by in data.table
classByGnEffSizeDT <- calcClustMetaEstStats(genewiseCohortsDT)
```

```{r save_results}
fwrite(classByGnEffSizeDT, file.path('..', 'results', 'classByGeneWeigthedEffSize.csv'))
```

## 13. Pathway Analysis

```{r load_data}
geneSetL <- loadGnSetGMTs(file.path("..", "data"))
names(geneSetL)
```

```{r }
rankedMetaClassGenes <- rankMetaClassGenesByEffSize(classByGnEffSizeDT)
```

```{r }
referenceGenes <- rownames(cohortsDataL[[1]])
pathwayStatsDT <- computePathwayScores(rankedMetaClassGenes, geneSetL, referenceGenes)
```

```{r }
pathwayHMPs <- heatmapPathwayScores(pathwayStatsDT, significance=0.05)
```

```{r}
ggarrangePlotL(pathwayHMPs, 3)
```

## 14. Published Classifier Subtyping

```{r }
classifFileL <- list.files(file.path('..', 'data'), pattern="centroid", 
                          ignore.case=TRUE, full.names=TRUE)

classifL <- lapply(classifFileL, readRDS)
names(classifL) <- gsub('^.*\\/|[Cc]entroid*|\\.[^\\.]*$', '', classifFileL)
```

```{r }
publishedClassifSubtypeDT <- subtypeDataLwClassifCentroidL(PGxCelllinesL, classifL, 
                                                          PGxCCLpreds, seed=1987)
```


```{r }
plotClassifierComparisons(publishedClassifSubtypeDT, allClassif=TRUE)
```

```{r caclualte_association_stats}
assocStatsDT <- calcAssocStats(publishedClassifSubtypeDT)
```

```{r heatmap_classif_assoc_stats}
heatmapClassifCors(assocStatsDT)
```