---
title: "Run CSPSC"
author: "Christopher Eeles"
date: "11/05/2020"
output: html_document
---

```{r}
#library(PanCuRx)
require(IDPmisc)
library(dplyr)
library(matrixStats)
library(factoextra)
library(NbClust)
library(cluster)
library(ConsensusClusterPlus)
library(clusterRepro)
library(igraph)
library(gtools)
library(plyr)
library(survival)
library(KMsurv)
library(survminer)
library(limma)
library(piano)
require(ggplot2)
library(ggpubr)
library(BiocParallel)
library(data.table)
library(effsize)
library(vcdExtra)
library(survcomp)
library(RColorBrewer)
library(lattice)
library(ggplotify)
library(gridExtra)
library(ggsci)
```

## 1. COINCIDE Implementation

```{r load_data}
cohortsDataL <- readRDS('../data/cohortsCommonGenes.rds')       
normalGTEx <- readRDS('../data/normalGTEx.rds')
adjNormal <- readRDS('../data/adjacentNormal.rds')
```


```{r source_function}
source('../R/utilities.R')
```

```{r rorder_cohorts_to_match}
cohortOrder <-c("pcsi", "tcga", 
                "kirby", "icgc_seq", 
                "ouh", "winter", 
                "collisson", "zhang", 
                "grutzmann", "chen", 
                "unc", "icgc_arr", 
                "balagurunathan", "badea", 
                "pei", "haider", 
                "lunardi", "yang", 
                "hamidi", "janky", "bauer")
cohortsDataL <- cohortsDataL[cohortOrder]
```

```{r ranking_genes_based_on_mad}
cohortMADrankings <- bplapply(cohortsDataL, function(cohort) calcRowMADdf(cohort))
```

```{r rank_cohort_genes_by_MAD}
geneWiseWeightedMADdf <- calcGeneWiseWeightedMADdf(cohortMADrankings)
```


```{r get_top_ranked_genes}
top20genesPerCohort <- getTopGenes(cohortMADrankings, n=20)
```


```{r get_top_genes_and_meta_genes}
metaGenes <- getMetaGenes(cohortMADrankings, geneWiseWeightedMADdf, n=20, m=2066)

resultsDir <- file.path("..", "results")
saveRDS(metaGenes, file.path(resultsDir, "metaGenes.rds"))
```



```{r preprocess_cohort_expression_matrixes}
preprocCohorts <- preprocessCohorts(cohorts, metaGenes)
```



```{r compute_consensus_cluster}
consensusClusters <- bplapply(preprocCohorts,
                              consensusClusterCohort,
                              maxK=5, distance="pearson", 
                              method="hc", seed=1987)
```

```{r consensus_cluster_normals_and_GTEx_normals}
normalCohorts <- list("normals"=adjNormal, 
                      "normalsGTEx"=normalGTEx)

preprocNormals <- preprocessCohorts(normalCohorts, metaGenes)
conClustNormals <- bplapply(preprocNormals,
                            consensusClusterCohort,
                            maxK=5, distance="pearson", 
                            method="hc", seed=1987)
```

```{r append_normals_to_cohorts}
allConClusters <- c(consensusClusters, conClustNormals)
allProcCohorts <- c(preprocCohorts, preprocNormals)
```


```{r get_all_pairs}
cohortPairs <- findAllCohortPairs(names(allConClusters))
```


```{r calculate_thresholds}
# 
MSMthresholds <- calcAllMSMthresholds(cohortPairs, allConClusters, allProcCohorts, nthread=16)
```


```{r compare_all_clusters}
a <- Sys.time()
allClusterRepro <- calcAllClusterRepro(MSMthresholds, allConClusters, 
                                       allProcCohorts, nthread=16, numReps=500,
                                       seed=1987)
b <- Sys.time()
b - a
```


```{r }
qsave(allClusterRepro, file.path('..', 'data', 'allClusterRepro.qs'), nthread=16)
```

```{r }
clusterEdges <- compareClusters(MSMthresholds, allClusterRepro, pValue=0.05, actualIGP=0.5, minThresh=0)
qsave(clusterEdges, file.path('..', 'data', 'clusterEdges.qs'), nthread=15)
```


```{r }
graphData <- getClusterNetworkData(clusterEdges, seed=1987)
graphData$metaClusters
```

```{r }
possibleClusters <- findAllPossibleClusters(allConClusters)
notClustered <- findCohortsNotClustered(possibleClusters, graphData$metaClusters)
notClustered
```

```{r cohortwise_classes}
cohortwiseClasses <- getCohortwiseClasses(graphData$metaClusters, notClustered)
cohortwiseClasses
```

```{r cohortCluster_samples}
clusterwiseSamples <- getClusterwiseSamples(cohortwiseClasses, allConClusters)
```

```{r }
annotatedClusters <- annotateSampleMetaClasses(allConClusters, clusterwiseSamples)
saveRDS(annotatedClusters, file.path("..", "results", "annotatedClusters.rds"))
```

## 2. Network Community Search

```{r cluster_network, fig.height=10, fig.width=10}
plotClusterNetwork(clusterEdges, seed=1987, 
                   savePath=file.path('..', 'results'),
                   fileName='clusterNetworkGraph.pdf')
```

```{r load_expression_data}
load(file=file.path('..', 'data', 'PDACexpressionData.rda'))
load(file=file.path('..', 'data', 'yangSurvival.rda'))
```

```{r extract_survival_data}
# Drop old PCSI
PDACexpressionData <- PDACexpressionData[which(names(PDACexpressionData) != "pcsi")]
survivalData <- extractSurvivalData(PDACexpressionData, yangSurvival)
head(survivalData)
```


```{r extract_meta_clusters}
metaClusters <- extractMetaClusters(annotatedClusters, survivalData)
head(metaClusters)
```


```{r merge_to_samples_with_survival_data}
metaClusterSurvival <- mergeOn(survivalData, metaClusters, "sampleNames")
head(metaClusterSurvival)
```


```{r annotate_metaClusters}
metaClusterSurvAnnot <- annotateMetaClusters(metaClusterSurvival, c("Basal", "Exocrine", "Classical"))
head(metaClusterSurvAnnot)
```


```{r fit_cox_model}
proportionalHarzardsModel <- fitProportionalHazardsModel(metaClusterSurvAnnot)
summary(proportionalHarzardsModel)
```

```{r }
survivalCurves <- fitSurvivalCurves(metaClusterSurvAnnot)
```

```{r }
plotSurvivalCurves(survivalCurves)
```

```{r, fig.height=12, fig.width=12}
plotCohortwiseSurvivalCurves(metaClusterSurvAnnot)
```

## 3. Gene Signature Comparison

```{r }
sampleMetaClassDT <- extractSampleMetaClasses(annotatedClusters)
head(sampleMetaClassDT)
```

```{r }
geneSigL <- readRDS(file=file.path("..", "data", "geneSigList.rds"))
sigScoreL <- mapply(computeSignatureScoreDT, geneSigL, 
                    MoreArgs=list(cohortsDataL=cohortsDataL, 
                                  sampleMetaClassDT=sampleMetaClassDT),
                    SIMPLIFY=FALSE)
```

```{r fig.height=10, fig.width=12}
comparisons <- list(c("Basal", "Classical"), 
                    c("Classical", "Exocrine"),
                    c("Exocrine", "Basal"))
sigScorePlotL <- mapply(plotSigScores, 
                        cohortSignatureScoreDT=sigScoreL,
                        signatureScoreName=names(sigScoreL),
                        MoreArgs=list(comparisons=comparisons),
                        SIMPLIFY=FALSE)
sigScorePlots <- grid.arrange(grobs=sigScorePlotL)
ggsave(file=file.path("..", "data", "sigScorePlots.pdf"), sigScorePlots)
```

```{r }
```

```{r }
```



## 4. Biomarker Comparison

```{r }
```

```{r }
```

```{r }
```


## 5. Single Sample Classifier 

```{r }
```

## 6. Compass Subtyping Waterfall


```{r }
```

## 7. PharmacoGx Cellline Subtyping

```{r }
```

## 8. PharmacoGx Cellline Drug Sensitivity 


```{r }
```

## 9. PDXE Drug Subtyping


```{r }
```


## 10. Cellarity Comparison


```{r }
```

## 11. Copy Number Abberation

```{r }
```

## 12. Caclulate Cluster Meta-Effect Size

```{r }
```

## 13. Pathway Analysis

```{r }
```

## 14. Published Classifier Subtyping

```{r }
```



```{r }
```



